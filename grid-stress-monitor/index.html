<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Stress Monitor — US ISO Real-Time Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/geist@1.2.0/dist/fonts/geist-sans/style.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --black: #000000;
            --charcoal: #18181B;
            --graphite: #27272A;
            --zinc: #3F3F46;
            --stone: #71717A;
            --silver: #A1A1AA;
            --smoke: #E4E4E7;
            --white: #FFFFFF;
            --electric: #3B82F6;
            --ember: #F59E0B;
            --jade: #10B981;
            --coral: #EF4444;
        }
        
        body {
            font-family: 'Geist', system-ui, sans-serif;
            background: var(--charcoal);
            color: var(--white);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            grid-template-rows: auto 1fr auto;
            height: 100vh;
            gap: 1px;
            background: var(--zinc);
        }
        
        header {
            grid-column: 1 / -1;
            background: var(--charcoal);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--zinc);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--coral);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--silver);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--jade);
            animation: pulse 2s infinite;
        }
        
        .status-dot.sample {
            background: var(--ember);
        }
        
        .status-dot.error {
            background: var(--coral);
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .data-badge {
            background: var(--graphite);
            border: 1px solid var(--zinc);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-badge.live {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--jade);
            color: var(--jade);
        }
        
        .data-badge.sample {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--ember);
            color: var(--ember);
        }
        
        .refresh-btn {
            background: var(--graphite);
            border: 1px solid var(--zinc);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--silver);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }
        
        .refresh-btn:hover {
            background: var(--zinc);
            color: var(--white);
        }
        
        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .sidebar-left {
            background: var(--charcoal);
            padding: 16px;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--stone);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-count {
            background: var(--graphite);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            color: var(--silver);
        }
        
        .system-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .mini-stat {
            background: var(--graphite);
            border-radius: 6px;
            padding: 12px;
        }
        
        .mini-stat-value {
            font-size: 20px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            font-feature-settings: "tnum";
        }
        
        .mini-stat-label {
            font-size: 10px;
            color: var(--stone);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 2px;
        }
        
        .alert-card {
            background: var(--graphite);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-left: 3px solid var(--coral);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .alert-card:hover {
            background: var(--zinc);
        }
        
        .alert-card.warning { border-left-color: var(--ember); }
        .alert-card.info { border-left-color: var(--electric); }
        .alert-card.watch { border-left-color: var(--stone); }
        
        .alert-iso {
            font-size: 9px;
            font-weight: 600;
            color: var(--stone);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .alert-title {
            font-size: 12px;
            font-weight: 500;
            margin: 2px 0;
        }
        
        .alert-time {
            font-size: 10px;
            color: var(--stone);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .fuel-mix {
            margin-top: 16px;
        }
        
        .fuel-bar-container {
            background: var(--graphite);
            border-radius: 6px;
            padding: 12px;
        }
        
        .fuel-bar {
            display: flex;
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .fuel-segment {
            transition: width 0.5s ease;
        }
        
        .fuel-legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px 12px;
        }
        
        .fuel-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }
        
        .fuel-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }
        
        .fuel-legend-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--silver);
            margin-left: auto;
        }
        
        .map-container {
            position: relative;
            background: var(--black);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(24, 24, 27, 0.95);
            border: 1px solid var(--zinc);
            border-radius: 8px;
            padding: 14px 16px;
            backdrop-filter: blur(8px);
        }
        
        .legend-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--stone);
            margin-bottom: 10px;
        }
        
        .legend-scale {
            display: flex;
            height: 12px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        
        .legend-scale-segment {
            flex: 1;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--stone);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .time-slider-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(24, 24, 27, 0.95);
            border: 1px solid var(--zinc);
            border-radius: 8px;
            padding: 12px 20px;
            backdrop-filter: blur(8px);
            min-width: 400px;
        }
        
        .time-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .time-slider-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--stone);
        }
        
        .time-slider-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
        }
        
        .time-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--graphite);
            border-radius: 3px;
            cursor: pointer;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--electric);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .sidebar-right {
            background: var(--charcoal);
            padding: 16px;
            overflow-y: auto;
        }
        
        .iso-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }
        
        .filter-btn {
            background: var(--graphite);
            border: 1px solid var(--zinc);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 10px;
            font-weight: 600;
            color: var(--silver);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .filter-btn:hover {
            background: var(--zinc);
        }
        
        .filter-btn.active {
            background: var(--electric);
            border-color: var(--electric);
            color: var(--white);
        }
        
        .stat-card {
            background: var(--graphite);
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -0.02em;
            font-feature-settings: "tnum";
        }
        
        .stat-value.negative { color: var(--jade); }
        .stat-value.high { color: var(--coral); }
        .stat-value.elevated { color: var(--ember); }
        
        .stat-label {
            font-size: 11px;
            color: var(--stone);
            margin-top: 2px;
        }
        
        .stat-detail {
            font-size: 10px;
            color: var(--silver);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--zinc);
        }
        
        .constraint-list {
            margin-top: 12px;
        }
        
        .constraint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--zinc);
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .constraint-item:hover {
            background: var(--graphite);
            margin: 0 -16px;
            padding: 8px 16px;
        }
        
        .constraint-name {
            font-size: 12px;
            font-weight: 500;
        }
        
        .constraint-iso {
            font-size: 9px;
            color: var(--stone);
            text-transform: uppercase;
        }
        
        .constraint-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: var(--coral);
        }
        
        .chart-container {
            background: var(--graphite);
            border-radius: 6px;
            padding: 14px;
            margin-top: 12px;
        }
        
        .chart-title {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-subtitle {
            font-size: 10px;
            color: var(--stone);
        }
        
        .mini-chart {
            height: 100px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }
        
        .chart-bar {
            flex: 1;
            background: var(--electric);
            border-radius: 2px 2px 0 0;
            min-height: 2px;
            opacity: 0.7;
            transition: all 0.15s;
            position: relative;
        }
        
        .chart-bar:hover {
            opacity: 1;
        }
        
        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--silver);
            opacity: 0;
            transition: opacity 0.15s;
            white-space: nowrap;
            padding-bottom: 4px;
        }
        
        .chart-bar:hover::after {
            opacity: 1;
        }
        
        .chart-bar.negative { background: var(--jade); }
        .chart-bar.high { background: var(--coral); }
        .chart-bar.elevated { background: var(--ember); }
        
        .chart-axis {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 9px;
            color: var(--stone);
            font-family: 'JetBrains Mono', monospace;
        }
        
        footer {
            grid-column: 1 / -1;
            background: var(--charcoal);
            padding: 10px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--zinc);
            font-size: 11px;
            color: var(--stone);
        }
        
        footer a {
            color: var(--silver);
            text-decoration: none;
        }
        
        footer a:hover {
            color: var(--white);
        }
        
        .mapboxgl-popup-content {
            background: var(--charcoal);
            border: 1px solid var(--zinc);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--white);
            font-family: 'Geist', system-ui, sans-serif;
        }
        
        .mapboxgl-popup-tip {
            border-top-color: var(--charcoal);
        }
        
        .mapboxgl-popup-close-button {
            color: var(--stone);
            font-size: 18px;
            padding: 4px 8px;
        }
        
        .popup-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .popup-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .popup-label {
            color: var(--stone);
        }
        
        .popup-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 60vh auto auto auto;
            }
            
            .sidebar-left, .sidebar-right {
                max-height: 300px;
            }
            
            .time-slider-container {
                width: calc(100% - 40px);
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </div>
                <h1>Grid Stress Monitor</h1>
            </div>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-dot" id="live-indicator"></span>
                    <span id="data-status">Connecting...</span>
                </div>
                <span class="data-badge" id="data-badge">LOADING</span>
                <div class="status-item" id="timestamp">
                    <span>Updated: --:--</span>
                </div>
                <button class="refresh-btn" id="refresh-btn" onclick="refreshData()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </header>
        
        <div class="sidebar-left">
            <div class="section-title">System Overview</div>
            <div class="system-stats">
                <div class="mini-stat">
                    <div class="mini-stat-value" id="total-demand">--</div>
                    <div class="mini-stat-label">ERCOT Load (GW)</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-stat-value" id="renewable-pct">--</div>
                    <div class="mini-stat-label">Renewable %</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-stat-value" id="reserve-margin">--</div>
                    <div class="mini-stat-label">Reserve Margin</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-stat-value" id="binding-count">--</div>
                    <div class="mini-stat-label">Binding Constraints</div>
                </div>
            </div>
            
            <div class="section-title">
                Generation Mix
                <span class="section-count" id="fuel-source">ERCOT</span>
            </div>
            <div class="fuel-mix">
                <div class="fuel-bar-container">
                    <div class="fuel-bar" id="fuel-bar"></div>
                    <div class="fuel-legend" id="fuel-legend"></div>
                </div>
            </div>
            
            <div class="section-title" style="margin-top: 16px;">
                Active Alerts
                <span class="section-count" id="alert-count">0</span>
            </div>
            <div id="alerts-container"></div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="map-legend">
                <div class="legend-title">LMP ($/MWh)</div>
                <div class="legend-scale">
                    <div class="legend-scale-segment" style="background: #10B981;"></div>
                    <div class="legend-scale-segment" style="background: #71717A;"></div>
                    <div class="legend-scale-segment" style="background: #3B82F6;"></div>
                    <div class="legend-scale-segment" style="background: #F59E0B;"></div>
                    <div class="legend-scale-segment" style="background: #EF4444;"></div>
                </div>
                <div class="legend-labels">
                    <span>&lt;$0</span>
                    <span>$30</span>
                    <span>$50</span>
                    <span>$80</span>
                    <span>&gt;$100</span>
                </div>
            </div>
            <div class="time-slider-container" id="time-slider-container" style="display: none;">
                <div class="time-slider-header">
                    <span class="time-slider-label">24-Hour History</span>
                    <span class="time-slider-value" id="time-slider-value">Now</span>
                </div>
                <input type="range" class="time-slider" id="time-slider" min="0" max="23" value="23">
            </div>
        </div>
        
        <div class="sidebar-right">
            <div class="section-title">ISO Filter</div>
            <div class="iso-filter">
                <button class="filter-btn active" data-iso="all">All</button>
                <button class="filter-btn" data-iso="ERCOT">ERCOT</button>
                <button class="filter-btn" data-iso="PJM">PJM</button>
                <button class="filter-btn" data-iso="CAISO">CAISO</button>
                <button class="filter-btn" data-iso="MISO">MISO</button>
                <button class="filter-btn" data-iso="SPP">SPP</button>
                <button class="filter-btn" data-iso="NYISO">NYISO</button>
            </div>
            
            <div class="section-title">Peak Prices</div>
            <div class="stat-card">
                <div class="stat-value high" id="peak-lmp">$--</div>
                <div class="stat-label">Highest LMP</div>
                <div class="stat-detail" id="peak-location">Loading...</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value negative" id="min-lmp">$--</div>
                <div class="stat-label">Lowest LMP (Curtailment)</div>
                <div class="stat-detail" id="min-location">Loading...</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value elevated" id="spread">$--</div>
                <div class="stat-label">Max LMP Spread</div>
                <div class="stat-detail">Indicates transmission congestion</div>
            </div>
            
            <div class="section-title" style="margin-top: 16px;">Top Constraints</div>
            <div class="constraint-list" id="constraints-list"></div>
            
            <div class="chart-container">
                <div class="chart-title">
                    <span>24h LMP Trend</span>
                    <span class="chart-subtitle" id="chart-zone">ERCOT Hub Avg</span>
                </div>
                <div class="mini-chart" id="lmp-chart"></div>
                <div class="chart-axis">
                    <span>24h ago</span>
                    <span>12h</span>
                    <span>Now</span>
                </div>
            </div>
        </div>
        
        <footer>
            <div>
                <span id="active-constraints">0 Binding Constraints</span> ·
                Data sources: <a href="https://www.ercot.com" target="_blank">ERCOT</a>,
                <a href="https://www.eia.gov" target="_blank">EIA</a>
            </div>
            <div>
                Grid Stress Monitor · <a href="LIVE_DATA_SOURCES.md">API Docs</a>
            </div>
        </footer>
    </div>
    
    <script>
        // ============================================================
        // DATA CONFIGURATION
        // ============================================================
        
        const CONFIG = {
            ERCOT_LMP_URL: 'https://www.ercot.com/content/cdr/html/hb_lz.html',
            ERCOT_FUEL_URL: 'https://www.ercot.com/api/1/services/read/dashboards/fuel-mix.json',
            ERCOT_SUPPLY_URL: 'https://www.ercot.com/api/1/services/read/dashboards/supply-demand.json',
            REFRESH_INTERVAL: 5 * 60 * 1000, // 5 minutes
            MAPBOX_TOKEN: 'pk.eyJ1Ijoib3dlbi1jb29uYWhhbiIsImEiOiJjbWowdmR2a20wZDVtM2Vwem5idGFpYm5vIn0.cgIL7QDk0gaaueSLBi8cjQ'
        };
        
        // Zone coordinates mapping
        const ZONE_COORDS = {
            // ERCOT Hubs and Load Zones
            'HB_HOUSTON': { lat: 29.76, lng: -95.37, name: 'Houston Hub' },
            'HB_NORTH': { lat: 32.78, lng: -96.80, name: 'North Hub' },
            'HB_SOUTH': { lat: 27.80, lng: -97.40, name: 'South Hub' },
            'HB_WEST': { lat: 31.76, lng: -106.49, name: 'West Hub' },
            'HB_PAN': { lat: 35.22, lng: -101.83, name: 'Panhandle Hub' },
            'HB_BUSAVG': { lat: 31.00, lng: -99.50, name: 'Bus Average' },
            'HB_HUBAVG': { lat: 30.50, lng: -98.50, name: 'Hub Average' },
            'LZ_HOUSTON': { lat: 29.95, lng: -95.10, name: 'Houston Zone' },
            'LZ_NORTH': { lat: 33.10, lng: -97.00, name: 'North Zone' },
            'LZ_SOUTH': { lat: 27.50, lng: -98.00, name: 'South Zone' },
            'LZ_WEST': { lat: 31.20, lng: -104.00, name: 'West Zone' },
            'LZ_CPS': { lat: 29.42, lng: -98.49, name: 'San Antonio' },
            'LZ_LCRA': { lat: 30.27, lng: -97.74, name: 'Austin/LCRA' },
            'LZ_AEN': { lat: 32.45, lng: -97.40, name: 'AEN Zone' },
            'LZ_RAYBN': { lat: 33.20, lng: -96.10, name: 'Rayburn Zone' },
            // Other ISOs (sample data)
            'PJM_PECO': { lat: 39.95, lng: -75.17, name: 'PJM Philadelphia' },
            'PJM_BGE': { lat: 39.29, lng: -76.61, name: 'PJM Baltimore' },
            'PJM_COMED': { lat: 41.88, lng: -87.63, name: 'PJM Chicago' },
            'CAISO_NP15': { lat: 38.58, lng: -121.49, name: 'CAISO NorCal' },
            'CAISO_SP15': { lat: 34.05, lng: -118.24, name: 'CAISO SoCal' },
            'MISO_CENTRAL': { lat: 39.10, lng: -94.58, name: 'MISO Central' },
            'SPP_CENTRAL': { lat: 35.47, lng: -97.52, name: 'SPP Central' },
            'NYISO_NYC': { lat: 40.71, lng: -74.01, name: 'NYISO NYC' }
        };
        
        // Fuel colors
        const FUEL_COLORS = {
            'Wind': '#10B981',
            'Solar': '#F59E0B',
            'Nuclear': '#8B5CF6',
            'Natural Gas': '#6B7280',
            'Coal and Lignite': '#374151',
            'Hydro': '#3B82F6',
            'Power Storage': '#EC4899',
            'Other': '#71717A'
        };
        
        // ============================================================
        // STATE
        // ============================================================
        
        let state = {
            isLive: false,
            lastUpdate: null,
            lmpData: [],
            fuelMix: null,
            supplyDemand: null,
            currentFilter: 'all',
            lmpHistory: [],
            markers: [],
            map: null
        };
        
        // ============================================================
        // SAMPLE DATA (fallback)
        // ============================================================
        
        const SAMPLE_LMP_DATA = [
            { zone: 'HB_HOUSTON', iso: 'ERCOT', lmp: 45.20, change: 2.10 },
            { zone: 'HB_NORTH', iso: 'ERCOT', lmp: 38.50, change: 1.50 },
            { zone: 'HB_SOUTH', iso: 'ERCOT', lmp: 52.80, change: 3.20 },
            { zone: 'HB_WEST', iso: 'ERCOT', lmp: -12.50, change: -8.40 },
            { zone: 'HB_PAN', iso: 'ERCOT', lmp: 28.90, change: 0.80 },
            { zone: 'LZ_HOUSTON', iso: 'ERCOT', lmp: 44.80, change: 2.00 },
            { zone: 'LZ_NORTH', iso: 'ERCOT', lmp: 39.20, change: 1.60 },
            { zone: 'LZ_SOUTH', iso: 'ERCOT', lmp: 55.30, change: 4.10 },
            { zone: 'LZ_WEST', iso: 'ERCOT', lmp: -8.20, change: -5.50 },
            { zone: 'LZ_CPS', iso: 'ERCOT', lmp: 48.60, change: 2.80 },
            { zone: 'LZ_LCRA', iso: 'ERCOT', lmp: 42.10, change: 1.90 },
            { zone: 'PJM_PECO', iso: 'PJM', lmp: 45.80, change: 1.20 },
            { zone: 'PJM_BGE', iso: 'PJM', lmp: 62.30, change: 3.50 },
            { zone: 'PJM_COMED', iso: 'PJM', lmp: 28.50, change: 0.40 },
            { zone: 'CAISO_NP15', iso: 'CAISO', lmp: 55.20, change: 2.80 },
            { zone: 'CAISO_SP15', iso: 'CAISO', lmp: 78.90, change: 5.20 },
            { zone: 'MISO_CENTRAL', iso: 'MISO', lmp: 22.40, change: 0.60 },
            { zone: 'SPP_CENTRAL', iso: 'SPP', lmp: -5.50, change: -3.20 },
            { zone: 'NYISO_NYC', iso: 'NYISO', lmp: 85.60, change: 4.80 }
        ];
        
        const SAMPLE_FUEL_MIX = {
            'Natural Gas': 45,
            'Wind': 22,
            'Nuclear': 12,
            'Coal and Lignite': 10,
            'Solar': 8,
            'Other': 3
        };
        
        const SAMPLE_ALERTS = [
            { iso: 'ERCOT', type: 'watch', title: 'High Wind Output - West Zone', time: '08:30' },
            { iso: 'CAISO', type: 'warning', title: 'Evening Ramp Alert', time: '14:00' },
            { iso: 'NYISO', type: 'info', title: 'High Load Forecast', time: '12:15' }
        ];
        
        const SAMPLE_CONSTRAINTS = [
            { name: 'Houston Import', iso: 'ERCOT', price: 15.60 },
            { name: 'West Texas Export', iso: 'ERCOT', price: 28.40 },
            { name: 'Central-East', iso: 'NYISO', price: 42.10 },
            { name: 'Path 26', iso: 'CAISO', price: 18.90 },
            { name: 'AP South', iso: 'PJM', price: 22.30 }
        ];
        
        // ============================================================
        // DATA FETCHING
        // ============================================================
        
        async function fetchERCOTLMP() {
            try {
                const response = await fetch(CONFIG.ERCOT_LMP_URL);
                if (!response.ok) throw new Error('ERCOT LMP fetch failed');
                
                const html = await response.text();
                return parseERCOTLMP(html);
            } catch (error) {
                console.warn('ERCOT LMP fetch error:', error);
                return null;
            }
        }
        
        function parseERCOTLMP(html) {
            const data = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const rows = doc.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const zone = cells[0]?.textContent?.trim();
                    const lmp = parseFloat(cells[1]?.textContent?.trim());
                    const change = parseFloat(cells[2]?.textContent?.trim());
                    
                    if (zone && !isNaN(lmp) && ZONE_COORDS[zone]) {
                        data.push({
                            zone,
                            iso: 'ERCOT',
                            lmp,
                            change: isNaN(change) ? 0 : change
                        });
                    }
                }
            });
            
            return data.length > 0 ? data : null;
        }
        
        async function fetchERCOTFuelMix() {
            try {
                const response = await fetch(CONFIG.ERCOT_FUEL_URL);
                if (!response.ok) throw new Error('ERCOT fuel mix fetch failed');
                
                const data = await response.json();
                return parseFuelMix(data);
            } catch (error) {
                console.warn('ERCOT fuel mix fetch error:', error);
                return null;
            }
        }
        
        function parseFuelMix(data) {
            if (!data?.data) return null;
            
            // Get the most recent data point
            const dates = Object.keys(data.data);
            if (dates.length === 0) return null;
            
            const latestDate = dates[dates.length - 1];
            const timestamps = Object.keys(data.data[latestDate]);
            if (timestamps.length === 0) return null;
            
            const latestTimestamp = timestamps[timestamps.length - 1];
            const fuelData = data.data[latestDate][latestTimestamp];
            
            const result = {};
            let total = 0;
            
            for (const [fuel, values] of Object.entries(fuelData)) {
                const gen = values.gen || 0;
                if (gen > 0) {
                    result[fuel] = gen;
                    total += gen;
                }
            }
            
            // Convert to percentages
            for (const fuel of Object.keys(result)) {
                result[fuel] = Math.round((result[fuel] / total) * 100);
            }
            
            return { mix: result, total, lastUpdated: data.lastUpdated };
        }
        
        async function fetchERCOTSupplyDemand() {
            try {
                const response = await fetch(CONFIG.ERCOT_SUPPLY_URL);
                if (!response.ok) throw new Error('ERCOT supply/demand fetch failed');
                
                const data = await response.json();
                return parseSupplyDemand(data);
            } catch (error) {
                console.warn('ERCOT supply/demand fetch error:', error);
                return null;
            }
        }
        
        function parseSupplyDemand(data) {
            if (!data?.data || data.data.length === 0) return null;
            
            const latest = data.data[data.data.length - 1];
            const history = data.data.slice(-24).map(d => ({
                demand: d.demand,
                capacity: d.capacity,
                timestamp: d.timestamp
            }));
            
            return {
                demand: latest.demand,
                capacity: latest.capacity,
                reserve: ((latest.capacity - latest.demand) / latest.demand * 100).toFixed(1),
                lastUpdated: data.lastUpdated,
                history
            };
        }
        
        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('loading');
            
            updateStatus('loading', 'Fetching...');
            
            try {
                // Fetch all ERCOT data in parallel
                const [lmpData, fuelMix, supplyDemand] = await Promise.all([
                    fetchERCOTLMP(),
                    fetchERCOTFuelMix(),
                    fetchERCOTSupplyDemand()
                ]);
                
                // Check if we got live data
                if (lmpData && lmpData.length > 0) {
                    state.isLive = true;
                    state.lmpData = [...lmpData, ...SAMPLE_LMP_DATA.filter(d => d.iso !== 'ERCOT')];
                    updateStatus('live', 'Live Data');
                } else {
                    state.isLive = false;
                    state.lmpData = SAMPLE_LMP_DATA;
                    updateStatus('sample', 'Sample Data');
                }
                
                state.fuelMix = fuelMix || { mix: SAMPLE_FUEL_MIX };
                state.supplyDemand = supplyDemand;
                state.lastUpdate = new Date();
                
                // Update all UI components
                renderMap();
                renderStats();
                renderFuelMix();
                renderAlerts();
                renderConstraints();
                renderChart();
                updateTimestamp();
                
            } catch (error) {
                console.error('Data refresh error:', error);
                state.isLive = false;
                state.lmpData = SAMPLE_LMP_DATA;
                updateStatus('error', 'Using Sample');
            }
            
            btn.classList.remove('loading');
        }
        
        // ============================================================
        // UI UPDATES
        // ============================================================
        
        function updateStatus(type, text) {
            const dot = document.getElementById('live-indicator');
            const status = document.getElementById('data-status');
            const badge = document.getElementById('data-badge');
            
            dot.className = 'status-dot';
            badge.className = 'data-badge';
            
            switch(type) {
                case 'live':
                    badge.textContent = 'LIVE';
                    badge.classList.add('live');
                    break;
                case 'sample':
                    dot.classList.add('sample');
                    badge.textContent = 'SAMPLE';
                    badge.classList.add('sample');
                    break;
                case 'error':
                    dot.classList.add('error');
                    badge.textContent = 'OFFLINE';
                    break;
                case 'loading':
                    badge.textContent = 'LOADING';
                    break;
            }
            
            status.textContent = text;
        }
        
        function updateTimestamp() {
            const el = document.getElementById('timestamp');
            const now = new Date();
            el.innerHTML = `<span>Updated: ${now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', second:'2-digit'})}</span>`;
        }
        
        function getStressColor(lmp) {
            if (lmp < 0) return '#10B981';      // Jade - curtailment
            if (lmp < 30) return '#71717A';     // Stone - normal
            if (lmp < 50) return '#3B82F6';     // Electric - elevated
            if (lmp < 80) return '#F59E0B';     // Ember - high
            return '#EF4444';                    // Coral - critical
        }
        
        function getStressLevel(lmp) {
            if (lmp < 0) return 'curtailment';
            if (lmp < 30) return 'normal';
            if (lmp < 50) return 'elevated';
            if (lmp < 80) return 'high';
            return 'critical';
        }
        
        // ============================================================
        // MAP
        // ============================================================
        
        function initMap() {
            mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;
            
            state.map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [-96, 36],
                zoom: 4
            });
            
            state.map.on('load', () => {
                renderMap();
            });
        }
        
        function renderMap() {
            if (!state.map) return;
            
            // Clear existing markers
            state.markers.forEach(m => m.remove());
            state.markers = [];
            
            // Filter data
            const filteredData = state.currentFilter === 'all' 
                ? state.lmpData 
                : state.lmpData.filter(d => d.iso === state.currentFilter);
            
            filteredData.forEach(point => {
                const coords = ZONE_COORDS[point.zone];
                if (!coords) return;
                
                const color = getStressColor(point.lmp);
                const size = Math.max(24, Math.min(50, 24 + Math.abs(point.lmp) / 3));
                
                const el = document.createElement('div');
                el.style.cssText = `
                    width: ${size}px;
                    height: ${size}px;
                    background: ${color};
                    border-radius: 50%;
                    border: 2px solid rgba(255,255,255,0.3);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: ${size > 35 ? 11 : 10}px;
                    font-weight: 600;
                    color: white;
                    font-family: 'JetBrains Mono', monospace;
                    box-shadow: 0 0 ${size/2}px ${color}60;
                    transition: transform 0.15s;
                `;
                el.textContent = point.lmp > 0 ? Math.round(point.lmp) : point.lmp.toFixed(0);
                
                el.addEventListener('mouseenter', () => {
                    el.style.transform = 'scale(1.1)';
                });
                el.addEventListener('mouseleave', () => {
                    el.style.transform = 'scale(1)';
                });
                
                const popup = new mapboxgl.Popup({ offset: 25, closeButton: true })
                    .setHTML(`
                        <div class="popup-header">${coords.name}</div>
                        <div class="popup-row">
                            <span class="popup-label">ISO</span>
                            <span class="popup-value">${point.iso}</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">LMP</span>
                            <span class="popup-value" style="color: ${color};">$${point.lmp.toFixed(2)}/MWh</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">5min Δ</span>
                            <span class="popup-value" style="color: ${point.change >= 0 ? '#EF4444' : '#10B981'};">
                                ${point.change >= 0 ? '+' : ''}${point.change.toFixed(2)}
                            </span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">Status</span>
                            <span class="popup-value" style="color: ${color}; text-transform: uppercase; font-size: 10px;">
                                ${getStressLevel(point.lmp)}
                            </span>
                        </div>
                    `);
                
                const marker = new mapboxgl.Marker(el)
                    .setLngLat([coords.lng, coords.lat])
                    .setPopup(popup)
                    .addTo(state.map);
                
                state.markers.push(marker);
            });
        }
        
        // ============================================================
        // STATS
        // ============================================================
        
        function renderStats() {
            const data = state.currentFilter === 'all' 
                ? state.lmpData 
                : state.lmpData.filter(d => d.iso === state.currentFilter);
            
            if (data.length === 0) return;
            
            // Peak/Min LMP
            const maxPoint = data.reduce((max, d) => d.lmp > max.lmp ? d : max, data[0]);
            const minPoint = data.reduce((min, d) => d.lmp < min.lmp ? d : min, data[0]);
            
            document.getElementById('peak-lmp').textContent = `$${maxPoint.lmp.toFixed(2)}`;
            document.getElementById('peak-lmp').className = `stat-value ${maxPoint.lmp > 80 ? 'high' : maxPoint.lmp > 50 ? 'elevated' : ''}`;
            document.getElementById('peak-location').textContent = `${ZONE_COORDS[maxPoint.zone]?.name || maxPoint.zone}`;
            
            document.getElementById('min-lmp').textContent = `$${minPoint.lmp.toFixed(2)}`;
            document.getElementById('min-lmp').className = `stat-value ${minPoint.lmp < 0 ? 'negative' : ''}`;
            document.getElementById('min-location').textContent = `${ZONE_COORDS[minPoint.zone]?.name || minPoint.zone}`;
            
            document.getElementById('spread').textContent = `$${(maxPoint.lmp - minPoint.lmp).toFixed(2)}`;
            
            // System stats (from ERCOT supply/demand)
            if (state.supplyDemand) {
                document.getElementById('total-demand').textContent = (state.supplyDemand.demand / 1000).toFixed(1);
                document.getElementById('reserve-margin').textContent = `${state.supplyDemand.reserve}%`;
            } else {
                document.getElementById('total-demand').textContent = '48.5';
                document.getElementById('reserve-margin').textContent = '18.2%';
            }
            
            // Renewable percentage
            if (state.fuelMix?.mix) {
                const renewable = (state.fuelMix.mix['Wind'] || 0) + (state.fuelMix.mix['Solar'] || 0) + (state.fuelMix.mix['Hydro'] || 0);
                document.getElementById('renewable-pct').textContent = `${renewable}%`;
            } else {
                document.getElementById('renewable-pct').textContent = '30%';
            }
            
            // Binding constraints
            const bindingCount = SAMPLE_CONSTRAINTS.filter(c => c.price > 15).length;
            document.getElementById('binding-count').textContent = bindingCount;
            document.getElementById('active-constraints').textContent = `${bindingCount} Binding Constraints`;
        }
        
        // ============================================================
        // FUEL MIX
        // ============================================================
        
        function renderFuelMix() {
            const mix = state.fuelMix?.mix || SAMPLE_FUEL_MIX;
            
            // Sort by percentage descending
            const sorted = Object.entries(mix)
                .filter(([_, v]) => v > 0)
                .sort((a, b) => b[1] - a[1]);
            
            // Render bar
            const bar = document.getElementById('fuel-bar');
            bar.innerHTML = sorted.map(([fuel, pct]) => `
                <div class="fuel-segment" style="width: ${pct}%; background: ${FUEL_COLORS[fuel] || '#71717A'};"></div>
            `).join('');
            
            // Render legend
            const legend = document.getElementById('fuel-legend');
            legend.innerHTML = sorted.map(([fuel, pct]) => `
                <div class="fuel-legend-item">
                    <div class="fuel-legend-dot" style="background: ${FUEL_COLORS[fuel] || '#71717A'};"></div>
                    <span>${fuel}</span>
                    <span class="fuel-legend-value">${pct}%</span>
                </div>
            `).join('');
        }
        
        // ============================================================
        // ALERTS
        // ============================================================
        
        function renderAlerts() {
            const container = document.getElementById('alerts-container');
            const alerts = SAMPLE_ALERTS;
            
            document.getElementById('alert-count').textContent = alerts.length;
            
            container.innerHTML = alerts.map(alert => `
                <div class="alert-card ${alert.type}">
                    <div class="alert-iso">${alert.iso}</div>
                    <div class="alert-title">${alert.title}</div>
                    <div class="alert-time">${alert.time}</div>
                </div>
            `).join('');
        }
        
        // ============================================================
        // CONSTRAINTS
        // ============================================================
        
        function renderConstraints() {
            const container = document.getElementById('constraints-list');
            const constraints = [...SAMPLE_CONSTRAINTS].sort((a, b) => b.price - a.price);
            
            container.innerHTML = constraints.slice(0, 5).map(c => `
                <div class="constraint-item">
                    <div>
                        <div class="constraint-name">${c.name}</div>
                        <div class="constraint-iso">${c.iso}</div>
                    </div>
                    <div class="constraint-price">$${c.price.toFixed(2)}</div>
                </div>
            `).join('');
        }
        
        // ============================================================
        // CHART
        // ============================================================
        
        function renderChart() {
            const container = document.getElementById('lmp-chart');
            
            // Use supply/demand history or generate sample
            let history;
            if (state.supplyDemand?.history) {
                // Map demand to pseudo-LMP for visualization
                history = state.supplyDemand.history.map(h => 
                    15 + (h.demand / 1000) * 0.8 + Math.random() * 10
                );
            } else {
                // Sample 24-hour pattern
                history = [28,25,22,20,22,28,38,52,65,72,78,82,85,88,87,85,72,68,65,55,45,38,32,28];
            }
            
            const max = Math.max(...history);
            const min = Math.min(...history);
            
            container.innerHTML = history.map((val, i) => {
                const height = ((val - min) / (max - min)) * 90 + 10;
                const level = getStressLevel(val);
                const cls = val > 80 ? 'high' : val > 50 ? 'elevated' : val < 0 ? 'negative' : '';
                return `<div class="chart-bar ${cls}" style="height: ${height}%;" data-value="$${val.toFixed(0)}"></div>`;
            }).join('');
        }
        
        // ============================================================
        // FILTERS
        // ============================================================
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentFilter = btn.dataset.iso;
                renderMap();
                renderStats();
            });
        });
        
        // ============================================================
        // INIT
        // ============================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            refreshData();
            
            // Auto-refresh every 5 minutes
            setInterval(refreshData, CONFIG.REFRESH_INTERVAL);
            
            // Update clock every second
            setInterval(updateTimestamp, 1000);
        });
    </script>
</body>
</html>
