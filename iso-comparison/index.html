<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US Energy Queue | 6.3 Terawatts in the Pipeline</title>
  <meta name="description" content="Visualizing 6.3 TW of proposed energy projects across America's 9 ISO regions">
  <link href="https://cdn.jsdelivr.net/npm/geist@1.2.0/dist/fonts/geist-sans/style.min.css" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <style>
    :root {
      --bg: #fafafa;
      --bg-card: #ffffff;
      --text: #18181b;
      --text-secondary: #71717a;
      --text-muted: #a1a1aa;
      --border: #e4e4e7;
      --accent: #2563eb;
      --accent-light: #dbeafe;
      --font: 'Geist', system-ui, -apple-system, sans-serif;
      
      /* Sankey colors */
      --solar: #f59e0b;
      --wind: #06b6d4;
      --storage: #8b5cf6;
      --gas: #6b7280;
      --hybrid: #10b981;
      
      /* Status colors */
      --active: #2563eb;
      --operational: #10b981;
      --withdrawn: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Hero Section */
    .hero {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      color: white;
      padding: 80px 24px;
      position: relative;
      overflow: hidden;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
    }

    .hero-content {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .hero-label {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.6);
      margin-bottom: 16px;
    }

    .hero h1 {
      font-size: clamp(48px, 8vw, 96px);
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1;
      margin-bottom: 16px;
    }

    .hero h1 span {
      background: linear-gradient(90deg, #60a5fa, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-subtitle {
      font-size: 20px;
      color: rgba(255,255,255,0.7);
      max-width: 600px;
      margin-bottom: 48px;
    }

    .hero-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 32px;
      max-width: 800px;
    }

    .hero-stat {
      border-left: 2px solid rgba(255,255,255,0.2);
      padding-left: 16px;
    }

    .hero-stat-value {
      font-size: 32px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .hero-stat-label {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
    }

    /* Section Styling */
    section {
      padding: 80px 0;
    }

    .section-header {
      margin-bottom: 48px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    .section-desc {
      font-size: 16px;
      color: var(--text-secondary);
      max-width: 600px;
    }

    /* Sankey Container */
    .sankey-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      overflow-x: auto;
    }

    .sankey-container svg {
      display: block;
      margin: 0 auto;
    }

    .sankey-node rect {
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .sankey-node:hover rect {
      opacity: 0.8;
    }

    .sankey-node text {
      font-family: var(--font);
      font-size: 12px;
      font-weight: 500;
      fill: var(--text);
    }

    .sankey-link {
      fill: none;
      stroke-opacity: 0.3;
      transition: stroke-opacity 0.2s;
    }

    .sankey-link:hover {
      stroke-opacity: 0.6;
    }

    /* Legend */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    /* Regional Cards */
    .region-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .region-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .region-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }

    .region-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .region-name {
      font-size: 18px;
      font-weight: 600;
    }

    .region-rank {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      background: var(--accent-light);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .region-capacity {
      font-size: 28px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin-bottom: 4px;
    }

    .region-projects {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .region-sparkline {
      height: 40px;
      margin-bottom: 16px;
    }

    .region-breakdown {
      display: flex;
      gap: 4px;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .region-breakdown-segment {
      height: 100%;
      transition: opacity 0.2s;
    }

    .region-breakdown-segment:hover {
      opacity: 0.8;
    }

    .region-status-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
    }

    /* Treemap */
    .treemap-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      overflow: hidden;
    }

    .treemap-cell {
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .treemap-cell:hover {
      opacity: 0.85;
    }

    .treemap-label {
      font-family: var(--font);
      font-weight: 600;
      fill: white;
      pointer-events: none;
    }

    .treemap-value {
      font-family: var(--font);
      font-size: 12px;
      fill: rgba(255,255,255,0.8);
      pointer-events: none;
    }

    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 900px) {
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    /* Footer */
    footer {
      padding: 48px 24px;
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-secondary);
      font-size: 13px;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      background: var(--text);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
      white-space: nowrap;
    }

    .tooltip.visible {
      opacity: 1;
    }

    /* Insights Banner */
    .insights {
      background: linear-gradient(90deg, var(--accent-light), #f0fdf4);
      border-radius: 12px;
      padding: 24px 32px;
      margin-bottom: 48px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .insights-icon {
      font-size: 24px;
    }

    .insights-text {
      font-size: 15px;
      color: var(--text);
    }

    .insights-text strong {
      font-weight: 600;
    }
  </style>
</head>
<body>

<!-- Hero Section -->
<section class="hero">
  <div class="hero-content">
    <div class="hero-label">US Interconnection Queues</div>
    <h1><span>6.3 TW</span> in the Pipeline</h1>
    <p class="hero-subtitle">
      35,469 energy projects totaling 6.3 terawatts are waiting to connect to America's power grid â€” 
      nearly 6Ã— the current installed capacity.
    </p>
    <div class="hero-stats">
      <div class="hero-stat">
        <div class="hero-stat-value">35,469</div>
        <div class="hero-stat-label">Total Projects</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value">9</div>
        <div class="hero-stat-label">ISO Regions</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value">1.35 TW</div>
        <div class="hero-stat-label">Solar Capacity</div>
      </div>
      <div class="hero-stat">
        <div class="hero-stat-value">70%</div>
        <div class="hero-stat-label">Withdrawn Rate</div>
      </div>
    </div>
  </div>
</section>

<div class="container">
  
  <!-- Insight Banner -->
  <div class="insights" style="margin-top: 48px;">
    <div class="insights-icon">ðŸ’¡</div>
    <div class="insights-text">
      <strong>Key Insight:</strong> Only 8% of queued capacity ever becomes operational. 
      The average project waits 4+ years in queue, and ERCOT leads in successful deployments.
    </div>
  </div>

  <!-- US to ISO Sankey -->
  <section>
    <div class="section-header">
      <div class="section-label">Flow Diagram</div>
      <h2 class="section-title">Where Is All This Capacity Going?</h2>
      <p class="section-desc">6.3 terawatts of proposed energy projects flow into 9 ISO regions. The Western Interconnection and MISO lead the pack.</p>
    </div>
    <div class="sankey-container">
      <div id="sankey-iso"></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background: #2563eb;"></div>Western ISOs (CAISO, West)</div>
        <div class="legend-item"><div class="legend-dot" style="background: #059669;"></div>Central ISOs (MISO, SPP, ERCOT)</div>
        <div class="legend-item"><div class="legend-dot" style="background: #7c3aed;"></div>Eastern ISOs (PJM, NYISO, ISO-NE)</div>
        <div class="legend-item"><div class="legend-dot" style="background: #dc2626;"></div>Southeast (Non-ISO)</div>
      </div>
    </div>
  </section>

  <!-- Technology Flow Sankey -->
  <section>
    <div class="section-header">
      <div class="section-label">Technology Mix</div>
      <h2 class="section-title">What's Being Built?</h2>
      <p class="section-desc">Solar dominates the queue, but wind and storage are close behind. See how each technology distributes across regions.</p>
    </div>
    <div class="sankey-container">
      <div id="sankey-tech"></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background: var(--solar);"></div>Solar</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--wind);"></div>Wind</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--storage);"></div>Storage</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--gas);"></div>Gas</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--hybrid);"></div>Solar + Storage</div>
      </div>
    </div>
  </section>

  <!-- Status Flow -->
  <section>
    <div class="section-header">
      <div class="section-label">Project Outcomes</div>
      <h2 class="section-title">What Happens to Projects?</h2>
      <p class="section-desc">Most projects never make it. 70% are withdrawn, only 8% become operational. Active projects still have hope.</p>
    </div>
    <div class="sankey-container">
      <div id="sankey-status"></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background: var(--operational);"></div>Operational (514 GW)</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--active);"></div>Active (1.3 TW)</div>
        <div class="legend-item"><div class="legend-dot" style="background: var(--withdrawn);"></div>Withdrawn (4.4 TW)</div>
      </div>
    </div>
  </section>

  <!-- Treemap Section -->
  <section>
    <div class="section-header">
      <div class="section-label">Capacity Breakdown</div>
      <h2 class="section-title">Technology Treemap</h2>
      <p class="section-desc">Area represents total capacity. Solar and Wind dominate, with storage growing rapidly.</p>
    </div>
    <div class="treemap-container">
      <div id="treemap"></div>
    </div>
  </section>

  <!-- Regional Cards -->
  <section>
    <div class="section-header">
      <div class="section-label">By Region</div>
      <h2 class="section-title">ISO Rankings</h2>
      <p class="section-desc">Ranked by total queue capacity. Each region has its own technology mix and success rate.</p>
    </div>
    <div class="region-grid" id="region-cards"></div>
  </section>

</div>

<footer>
  <div class="container">
    Data from public ISO queue filings â€¢ Last updated February 2026 â€¢ 
    Built by <a href="#">Prospector Labs</a>
  </div>
</footer>

<div class="tooltip" id="tooltip"></div>

<script>
// Data
const isoData = [
  { name: 'West', capacity: 1133237, projects: 6008, active: 356301, operational: 51304, withdrawn: 681175 },
  { name: 'MISO', capacity: 1001656, projects: 5435, active: 232427, operational: 153743, withdrawn: 615485 },
  { name: 'PJM', capacity: 876166, projects: 8152, active: 187464, operational: 97034, withdrawn: 580185 },
  { name: 'ERCOT', capacity: 798474, projects: 3768, active: 235877, operational: 78567, withdrawn: 484031 },
  { name: 'CAISO', capacity: 708171, projects: 2837, active: 88523, operational: 31608, withdrawn: 588040 },
  { name: 'Southeast', capacity: 636066, projects: 2879, active: 117975, operational: 69322, withdrawn: 447068 },
  { name: 'SPP', capacity: 581049, projects: 2841, active: 71181, operational: 3270, withdrawn: 506598 },
  { name: 'NYISO', capacity: 385307, projects: 1948, active: 155, operational: 12439, withdrawn: 348164 },
  { name: 'ISO-NE', capacity: 206148, projects: 1601, active: 15437, operational: 16753, withdrawn: 173958 }
];

const techByRegion = {
  'Solar': { MISO: 304700, ERCOT: 257334, PJM: 201384, Southeast: 152604, West: 147837, CAISO: 122779, SPP: 119556, NYISO: 34970, 'ISO-NE': 10247 },
  'Wind': { MISO: 256768, West: 248394, SPP: 237788, ERCOT: 164908, PJM: 107673, CAISO: 63929, 'ISO-NE': 47098, NYISO: 37278, Southeast: 12533 },
  'Storage': { CAISO: 193556, West: 173116, MISO: 102493, NYISO: 101450, PJM: 75210, SPP: 62024, 'ISO-NE': 42631, ERCOT: 39872, Southeast: 24671 },
  'Gas': { PJM: 317566, Southeast: 237083, MISO: 153239, ERCOT: 110244, SPP: 97907, West: 87354, CAISO: 71392, NYISO: 52418, 'ISO-NE': 20225 },
  'Solar + Storage': { West: 378722, CAISO: 191634, Southeast: 49650, PJM: 46007, SPP: 35226, NYISO: 11041, 'ISO-NE': 163 }
};

const techColors = {
  'Solar': '#f59e0b',
  'Wind': '#06b6d4',
  'Storage': '#8b5cf6',
  'Gas': '#6b7280',
  'Solar + Storage': '#10b981'
};

const statusColors = {
  'Active': '#2563eb',
  'Operational': '#10b981',
  'Withdrawn': '#ef4444'
};

const regionColors = {
  'West': '#2563eb',
  'CAISO': '#3b82f6',
  'MISO': '#059669',
  'SPP': '#10b981',
  'ERCOT': '#34d399',
  'PJM': '#7c3aed',
  'NYISO': '#8b5cf6',
  'ISO-NE': '#a78bfa',
  'Southeast': '#dc2626'
};

// Tooltip
const tooltip = d3.select('#tooltip');

function showTooltip(event, text) {
  tooltip
    .html(text)
    .style('left', (event.pageX + 10) + 'px')
    .style('top', (event.pageY - 10) + 'px')
    .classed('visible', true);
}

function hideTooltip() {
  tooltip.classed('visible', false);
}

// Format numbers
function formatGW(mw) {
  return (mw / 1000).toFixed(0) + ' GW';
}

function formatTW(mw) {
  return (mw / 1000000).toFixed(2) + ' TW';
}

// Create ISO Sankey
function createISOSankey() {
  const width = 900;
  const height = 500;
  
  const svg = d3.select('#sankey-iso')
    .append('svg')
    .attr('width', width)
    .attr('height', height)
    .attr('viewBox', `0 0 ${width} ${height}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const sankey = d3.sankey()
    .nodeWidth(20)
    .nodePadding(20)
    .extent([[50, 20], [width - 150, height - 20]]);

  const nodes = [
    { name: 'US Queue\n6.3 TW' },
    ...isoData.map(d => ({ name: d.name }))
  ];

  const links = isoData.map((d, i) => ({
    source: 0,
    target: i + 1,
    value: d.capacity
  }));

  const graph = sankey({
    nodes: nodes.map(d => Object.assign({}, d)),
    links: links.map(d => Object.assign({}, d))
  });

  // Links
  svg.append('g')
    .selectAll('path')
    .data(graph.links)
    .join('path')
    .attr('class', 'sankey-link')
    .attr('d', d3.sankeyLinkHorizontal())
    .attr('stroke', d => regionColors[d.target.name] || '#94a3b8')
    .attr('stroke-width', d => Math.max(1, d.width))
    .on('mouseover', (event, d) => showTooltip(event, `${d.target.name}: ${formatGW(d.value)}`))
    .on('mouseout', hideTooltip);

  // Nodes
  const node = svg.append('g')
    .selectAll('g')
    .data(graph.nodes)
    .join('g')
    .attr('class', 'sankey-node');

  node.append('rect')
    .attr('x', d => d.x0)
    .attr('y', d => d.y0)
    .attr('height', d => d.y1 - d.y0)
    .attr('width', d => d.x1 - d.x0)
    .attr('fill', d => d.index === 0 ? '#1e3a5f' : regionColors[d.name] || '#94a3b8')
    .attr('rx', 3);

  node.append('text')
    .attr('x', d => d.x0 < width / 2 ? d.x1 + 8 : d.x0 - 8)
    .attr('y', d => (d.y1 + d.y0) / 2)
    .attr('dy', '0.35em')
    .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
    .text(d => d.name.split('\n')[0])
    .style('font-weight', d => d.index === 0 ? '700' : '500');

  // Add capacity labels
  node.filter(d => d.index > 0)
    .append('text')
    .attr('x', d => d.x0 - 8)
    .attr('y', d => (d.y1 + d.y0) / 2)
    .attr('dy', '0.35em')
    .attr('text-anchor', 'end')
    .attr('fill', '#71717a')
    .style('font-size', '11px')
    .text(d => formatGW(d.value));
}

// Create Technology Sankey
function createTechSankey() {
  const width = 900;
  const height = 550;
  
  const svg = d3.select('#sankey-tech')
    .append('svg')
    .attr('width', width)
    .attr('height', height)
    .attr('viewBox', `0 0 ${width} ${height}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const sankey = d3.sankey()
    .nodeWidth(20)
    .nodePadding(15)
    .extent([[80, 20], [width - 100, height - 20]]);

  const techs = Object.keys(techByRegion);
  const regions = ['West', 'MISO', 'PJM', 'ERCOT', 'CAISO', 'Southeast', 'SPP', 'NYISO', 'ISO-NE'];
  
  const nodes = [
    ...techs.map(t => ({ name: t, type: 'tech' })),
    ...regions.map(r => ({ name: r, type: 'region' }))
  ];

  const links = [];
  techs.forEach((tech, ti) => {
    regions.forEach((region, ri) => {
      const value = techByRegion[tech][region];
      if (value && value > 10000) { // Only show significant flows
        links.push({
          source: ti,
          target: techs.length + ri,
          value: value,
          tech: tech
        });
      }
    });
  });

  const graph = sankey({
    nodes: nodes.map(d => Object.assign({}, d)),
    links: links.map(d => Object.assign({}, d))
  });

  // Links
  svg.append('g')
    .selectAll('path')
    .data(graph.links)
    .join('path')
    .attr('class', 'sankey-link')
    .attr('d', d3.sankeyLinkHorizontal())
    .attr('stroke', d => techColors[d.tech])
    .attr('stroke-width', d => Math.max(1, d.width))
    .on('mouseover', (event, d) => showTooltip(event, `${d.tech} â†’ ${graph.nodes[d.target.index].name}: ${formatGW(d.value)}`))
    .on('mouseout', hideTooltip);

  // Nodes
  const node = svg.append('g')
    .selectAll('g')
    .data(graph.nodes)
    .join('g')
    .attr('class', 'sankey-node');

  node.append('rect')
    .attr('x', d => d.x0)
    .attr('y', d => d.y0)
    .attr('height', d => d.y1 - d.y0)
    .attr('width', d => d.x1 - d.x0)
    .attr('fill', d => d.type === 'tech' ? techColors[d.name] : regionColors[d.name])
    .attr('rx', 3);

  node.append('text')
    .attr('x', d => d.type === 'tech' ? d.x0 - 8 : d.x1 + 8)
    .attr('y', d => (d.y1 + d.y0) / 2)
    .attr('dy', '0.35em')
    .attr('text-anchor', d => d.type === 'tech' ? 'end' : 'start')
    .text(d => d.name)
    .style('font-weight', '500');
}

// Create Status Sankey
function createStatusSankey() {
  const width = 900;
  const height = 500;
  
  const svg = d3.select('#sankey-status')
    .append('svg')
    .attr('width', width)
    .attr('height', height)
    .attr('viewBox', `0 0 ${width} ${height}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const sankey = d3.sankey()
    .nodeWidth(20)
    .nodePadding(15)
    .extent([[80, 20], [width - 120, height - 20]]);

  const regions = isoData.map(d => d.name);
  const statuses = ['Active', 'Operational', 'Withdrawn'];
  
  const nodes = [
    ...regions.map(r => ({ name: r, type: 'region' })),
    ...statuses.map(s => ({ name: s, type: 'status' }))
  ];

  const links = [];
  isoData.forEach((region, ri) => {
    links.push({ source: ri, target: regions.length, value: region.active, status: 'Active' });
    links.push({ source: ri, target: regions.length + 1, value: region.operational, status: 'Operational' });
    links.push({ source: ri, target: regions.length + 2, value: region.withdrawn, status: 'Withdrawn' });
  });

  const graph = sankey({
    nodes: nodes.map(d => Object.assign({}, d)),
    links: links.map(d => Object.assign({}, d))
  });

  // Links
  svg.append('g')
    .selectAll('path')
    .data(graph.links)
    .join('path')
    .attr('class', 'sankey-link')
    .attr('d', d3.sankeyLinkHorizontal())
    .attr('stroke', d => statusColors[d.status])
    .attr('stroke-width', d => Math.max(1, d.width))
    .on('mouseover', (event, d) => showTooltip(event, `${graph.nodes[d.source.index].name} â†’ ${d.status}: ${formatGW(d.value)}`))
    .on('mouseout', hideTooltip);

  // Nodes
  const node = svg.append('g')
    .selectAll('g')
    .data(graph.nodes)
    .join('g')
    .attr('class', 'sankey-node');

  node.append('rect')
    .attr('x', d => d.x0)
    .attr('y', d => d.y0)
    .attr('height', d => d.y1 - d.y0)
    .attr('width', d => d.x1 - d.x0)
    .attr('fill', d => d.type === 'region' ? regionColors[d.name] : statusColors[d.name])
    .attr('rx', 3);

  node.append('text')
    .attr('x', d => d.type === 'region' ? d.x0 - 8 : d.x1 + 8)
    .attr('y', d => (d.y1 + d.y0) / 2)
    .attr('dy', '0.35em')
    .attr('text-anchor', d => d.type === 'region' ? 'end' : 'start')
    .text(d => d.name)
    .style('font-weight', '500');
}

// Create Treemap
function createTreemap() {
  const width = 900;
  const height = 400;
  
  const data = {
    name: 'Technologies',
    children: [
      { name: 'Solar', value: 1351410 },
      { name: 'Wind', value: 1176368 },
      { name: 'Gas', value: 1147428 },
      { name: 'Storage', value: 815023 },
      { name: 'Solar + Storage', value: 712441 },
      { name: 'Other', value: 439928 },
      { name: 'Offshore Wind', value: 170223 }
    ]
  };

  const svg = d3.select('#treemap')
    .append('svg')
    .attr('width', width)
    .attr('height', height)
    .attr('viewBox', `0 0 ${width} ${height}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const treemap = d3.treemap()
    .size([width, height])
    .padding(3)
    .round(true);

  const root = d3.hierarchy(data)
    .sum(d => d.value)
    .sort((a, b) => b.value - a.value);

  treemap(root);

  const colorScale = {
    'Solar': '#f59e0b',
    'Wind': '#06b6d4',
    'Gas': '#6b7280',
    'Storage': '#8b5cf6',
    'Solar + Storage': '#10b981',
    'Other': '#94a3b8',
    'Offshore Wind': '#0891b2'
  };

  const cell = svg.selectAll('g')
    .data(root.leaves())
    .join('g')
    .attr('transform', d => `translate(${d.x0},${d.y0})`);

  cell.append('rect')
    .attr('class', 'treemap-cell')
    .attr('width', d => d.x1 - d.x0)
    .attr('height', d => d.y1 - d.y0)
    .attr('fill', d => colorScale[d.data.name] || '#94a3b8')
    .attr('rx', 4)
    .on('mouseover', (event, d) => showTooltip(event, `${d.data.name}: ${formatGW(d.data.value)}`))
    .on('mouseout', hideTooltip);

  cell.append('text')
    .attr('class', 'treemap-label')
    .attr('x', 12)
    .attr('y', 28)
    .text(d => d.x1 - d.x0 > 80 ? d.data.name : '');

  cell.append('text')
    .attr('class', 'treemap-value')
    .attr('x', 12)
    .attr('y', 48)
    .text(d => d.x1 - d.x0 > 80 ? formatGW(d.data.value) : '');
}

// Create Region Cards with sparklines
function createRegionCards() {
  const container = document.getElementById('region-cards');
  
  // Historical data for sparklines (simplified)
  const trends = {
    'West': [51, 118, 182, 233, 79],
    'MISO': [43, 62, 176, 5, 140],
    'PJM': [67, 107, 59, 33, 0],
    'ERCOT': [45, 58, 67, 92, 98],
    'CAISO': [44, 108, 0, 215, 0],
    'Southeast': [34, 28, 37, 57, 58],
    'SPP': [20, 22, 24, 87, 124],
    'NYISO': [28, 25, 57, 42, 90],
    'ISO-NE': [10, 15, 22, 23, 19]
  };

  isoData.forEach((region, i) => {
    const successRate = ((region.operational / region.capacity) * 100).toFixed(1);
    const activeRate = ((region.active / region.capacity) * 100).toFixed(0);
    
    const card = document.createElement('div');
    card.className = 'region-card';
    card.innerHTML = `
      <div class="region-card-header">
        <div class="region-name">${region.name}</div>
        <div class="region-rank">#${i + 1}</div>
      </div>
      <div class="region-capacity">${formatGW(region.capacity)}</div>
      <div class="region-projects">${region.projects.toLocaleString()} projects</div>
      <div class="region-sparkline" id="spark-${region.name}"></div>
      <div class="region-breakdown">
        <div class="region-breakdown-segment" style="flex: ${region.operational}; background: var(--operational);" title="Operational"></div>
        <div class="region-breakdown-segment" style="flex: ${region.active}; background: var(--active);" title="Active"></div>
        <div class="region-breakdown-segment" style="flex: ${region.withdrawn}; background: var(--withdrawn);" title="Withdrawn"></div>
      </div>
      <div class="region-status-row">
        <span><span class="status-dot" style="background: var(--operational);"></span>${successRate}% operational</span>
        <span><span class="status-dot" style="background: var(--active);"></span>${activeRate}% active</span>
      </div>
    `;
    container.appendChild(card);

    // Create sparkline
    const sparkData = trends[region.name] || [0, 0, 0, 0, 0];
    createSparkline(`spark-${region.name}`, sparkData, regionColors[region.name]);
  });
}

function createSparkline(containerId, data, color) {
  const container = document.getElementById(containerId);
  const width = container.offsetWidth || 200;
  const height = 40;
  
  const svg = d3.select(`#${containerId}`)
    .append('svg')
    .attr('width', '100%')
    .attr('height', height);

  const x = d3.scaleLinear()
    .domain([0, data.length - 1])
    .range([0, width]);

  const y = d3.scaleLinear()
    .domain([0, d3.max(data)])
    .range([height - 4, 4]);

  const line = d3.line()
    .x((d, i) => x(i))
    .y(d => y(d))
    .curve(d3.curveMonotoneX);

  // Area
  const area = d3.area()
    .x((d, i) => x(i))
    .y0(height)
    .y1(d => y(d))
    .curve(d3.curveMonotoneX);

  svg.append('path')
    .datum(data)
    .attr('fill', color)
    .attr('fill-opacity', 0.1)
    .attr('d', area);

  svg.append('path')
    .datum(data)
    .attr('fill', 'none')
    .attr('stroke', color)
    .attr('stroke-width', 2)
    .attr('d', line);

  // End dot
  svg.append('circle')
    .attr('cx', x(data.length - 1))
    .attr('cy', y(data[data.length - 1]))
    .attr('r', 4)
    .attr('fill', color);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  createISOSankey();
  createTechSankey();
  createStatusSankey();
  createTreemap();
  createRegionCards();
});
</script>

</body>
</html>
